---
title: "Mengyi - overview"
author: "Mengyi Zhang"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Module 3}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```


```{r, waring=FALSE, message=FALSE, fig.align = "center"}
library(BostonBikeSharingSystem)
library(dplyr)
library(tidyr)
library(tidyverse)
library(ggplot2)
library(rgdal)
library(sf)
library(gstat)
library(gridExtra)
library(RColorBrewer)

# Data path
dataPath <- "D:/R_final/BikeSharing_project/BostonBikeSharingSystem/Data/SocDem"
bikePath <- "D:/R_final/BikeSharing_project/BlueBike"
censusPath <- dir("../Data/SocDem/", pattern = ".csv", full.names = TRUE)

# Read in shapefiles and station loction data
sa <- dir(dataPath, pattern = "boston_group.shp", full.names = TRUE) %>%
  st_read() %>% select(COUNTYFP10, GEOID10)
subway <- dir(dataPath, pattern = "subway.shp", full.names = TRUE) %>%
  st_read()
bus <- dir(dataPath, pattern = "busroute.shp", full.names = TRUE) %>%
  st_read()
colleges <- dir(dataPath, pattern = "universities.shp", full.names = TRUE) %>%
  st_read()
bstation <- dir(bikePath, pattern = "Hubway_Stations_as_of_July_2017.csv", 
                full.names = TRUE) %>% read_csv() %>% 
  st_as_sf(., coords = c("Longitude", "Latitude"), crs = 4326) %>% 
  st_transform(x = ., crs = st_crs(sa))

# Read in census data and set the name for each dataset
names <- censusPath %>% basename() %>% strsplit(., "[.]") %>% unlist
census <- censusPath %>% 
   map(function(x) {
     read_csv(x) %>% rename(GEOID10 = Id2) 
   }) %>% set_names(names[!names %in% "csv"])

# Set value 0 to NA
is.na(census$housingunit) <- !census$housingunit
is.na(census$medhincome) <- !census$medhincome

# Add fields for visualization
popdata <- census$poprace %>% select(-GEOID10, -Total)
census$poprace <- census$poprace %>%
  mutate(Majority = colnames(popdata)[max.col(popdata, ties.method = "first")])

census$worktransmeans <- census$worktransmeans %>% 
  mutate(Percentage = Bicycle / Total)

# Change the class of GEOID10 in census dataset for join
census <- sapply(census, function(x) {
  x$GEOID10 <- x$GEOID10 %>% as.factor()
  return(x)
})

# Join census dataset to study area shapefile
censusshp <- sapply(census, function(x) {
  left_join(sa, x, by = "GEOID10")
})

# Visualize the data and save plots as png files
ggplot(sa %>% st_union()) +
  geom_sf(aes(fill = "Study Area")) +
  geom_sf(data = bus, aes(colour = "Bus Routes"), show.legend = "line") +
  geom_sf(data = subway, aes(color = "Subway Routes"), show.legend = "line") +
  geom_sf(data = bstation, aes(color = "Bluebikes Stations"), 
          show.legend = "point") +
  scale_fill_manual(values = ("Study Area" = "grey"),
                    guide = guide_legend(override.aes = 
                                           list(linetype = "blank",shape = NA))) +
  scale_color_manual(values = c("Bus Routes" = "honeydew2",
                                "Subway Routes" = "orange",
                                "Bluebikes Stations" = "deepskyblue"),
                     guide = guide_legend(override.aes = 
                                            list(linetype = 
                                                   c("blank", "solid", "solid"),
                                                 shape = c(20, NA, NA)))) +
  labs(title = "Bluebikes Stations in Boston Area") +
  theme(axis.title  = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank())
ggsave("bikestations.png", path = "../vignettes/fig", dpi = 120,
       width = 6, height = 6, units = "in")

ggplot(sa %>% st_union()) +
  geom_sf(aes(fill = "Study Area")) +
  geom_sf(data = colleges, aes(colour = "Colleges and Universities"), 
          show.legend = "point") +
  scale_fill_manual(values = ("Study Area" = "grey"),
                    guide = guide_legend(override.aes = 
                                           list(linetype = "blank",shape = NA))) +
  scale_color_manual(values = c("Colleges and Universities" = "tan3"),
                     guide = guide_legend(override.aes = 
                                            list(linetype = "blank",
                                                 shape = 18))) +
  labs(title = "Colleges and Universities in Boston Area") +
  theme(axis.title  = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank())
ggsave("colleges.png", path = "../vignettes/fig", dpi = 120,
       width = 6, height = 6, units = "in")

ggplot(censusshp$housingunit) + 
  geom_sf(aes(fill = Total)) +
  scale_fill_gradientn(colors = brewer.pal(n = 8, name = "Oranges")) +
  labs(title = "Number of Housing Units",
       subtitle = "Boston Area, Level: Census Block Group") +
  theme(axis.title  = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank())
ggsave("housingunits.png", path = "../vignettes/fig", dpi = 120,
       width = 6, height = 6, units = "in")

ggplot(censusshp$medhincome) + 
  geom_sf(aes(fill = Income)) +
  scale_fill_gradientn(colors = brewer.pal(n = 8, name = "GnBu")) +
  labs(title = "Median Household Income",
       subtitle = "Boston Area, Level: Census Block Group") +
  theme(axis.title  = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank())
ggsave("medianincome.png", path = "../vignettes/fig", dpi = 120,
       width = 6, height = 6, units = "in")

npop <- censusshp$poprace[censusshp$poprace$Total == 0, ]
ggplot(censusshp$poprace) + 
  geom_sf(aes(fill = Total)) +
  scale_fill_gradientn(colors = brewer.pal(n = 8, name = "YlOrBr")) +
  geom_sf(data = npop, fill = "grey48") +
  labs(title = "Total Number of Population",
       subtitle = "Boston Area, Level: Census Block Group") +
  theme(axis.title  = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank())
ggsave("poptotal.png", path = "../vignettes/fig", dpi = 120,
       width = 6, height = 6, units = "in")

ggplot(censusshp$poprace) + 
  geom_sf(aes(fill = Majority)) +
  scale_fill_manual(values = brewer.pal(n = 5, name = "Set3")) +
  geom_sf(data = npop, fill = "grey48") +
  labs(title = "Majority Race of Population",
       subtitle = "Boston Area, Level: Census Block Group") +
  theme(axis.title  = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank())
ggsave("poprace.png", path = "../vignettes/fig", dpi = 120,
       width = 8, height = 8, units = "in")

nworkmeans <- censusshp$worktransmeans[censusshp$worktransmeans$Total == 0, ]
ggplot(censusshp$worktransmeans) + 
  geom_sf(aes(fill = Percentage)) +
  scale_fill_gradientn(colors = brewer.pal(n = 8, name = "Purples")) +
  geom_sf(data = nworkmeans, fill = "grey48") +
  labs(title = "Percentage of Workers Riding the Bike to Work",
       subtitle = "Boston Area, Level: Census Block Group") +
  theme(axis.title  = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank())
ggsave("workmeans.png", path = "../vignettes/fig", dpi = 120,
       width = 6, height = 6, units = "in")


##########################################################################
#tmap tmshape


Path15 <- dir("D:/R_final/BikeSharing_project/BlueBike/2015", 
                  pattern = ".csv", full.names = TRUE)
# Read in trip data
names15 <- Path15 %>% basename() %>% substr(., start = 1, stop = 13)
trips15 <- Path15 %>% 
   map(function(x) {
     read_csv(x) %>% 
       select()
   }) %>% set_names(names15)
tPath15 <- dir("D:/R_final/BikeSharing_project/BlueBike/2015", 
                  pattern = "201502", full.names = TRUE)
ttttrips15 <- tPath15 %>% 
   map(function(x) {
     read_csv(x) 
   })
ttttrips15[1] %>% select(-"start station longitude")
```
